name: Build and publish the_project application

on:
  push:
    branches: [ "main" ]
    paths:
      - "the_project/**"
      - ".github/workflows/the_project.yaml"

jobs:
  build-publish:
    name: Build, Push, Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Detect which parts changed (so we build only what we need)
      - name: Detect changed paths
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            todo_app:
              - 'the_project/todo-app/**'
            todo_backend:
              - 'the_project/todo-backend/**'
            broadcaster:
              - 'the_project/broadcaster/**'
            manifests:
              - 'the_project/**/manifests/**'
              - 'the_project/kustomization.yaml'
              - 'the_project/postgres/**'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push todo-app
        if: steps.changes.outputs.todo_app == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ./the_project/todo-app
          push: true
          platforms: linux/amd64,linux/arm64
          tags: dazakharova/todo-app:${{ github.sha }}

      - name: Build & push todo-backend
        if: steps.changes.outputs.todo_backend == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ./the_project/todo-backend
          push: true
          platforms: linux/amd64,linux/arm64
          tags: dazakharova/todo-backend:${{ github.sha }}

      - name: Build & push todo-broadcaster
        if: steps.changes.outputs.broadcaster == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ./the_project/broadcaster
          push: true
          platforms: linux/amd64,linux/arm64
          tags: dazakharova/todo-broadcaster:${{ github.sha }}

      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Bump image tags in kustomization.yaml
        if: |
          steps.changes.outputs.todo_app == 'true' ||
          steps.changes.outputs.todo_backend == 'true' ||
          steps.changes.outputs.broadcaster == 'true'
        run: |
          cd the_project

          if [ "${{ steps.changes.outputs.todo_app }}" = "true" ]; then
            kustomize edit set image dazakharova/todo-app=dazakharova/todo-app:${{ github.sha }}
          fi

          if [ "${{ steps.changes.outputs.todo_backend }}" = "true" ]; then
            kustomize edit set image dazakharova/todo-backend=dazakharova/todo-backend:${{ github.sha }}
          fi

          if [ "${{ steps.changes.outputs.broadcaster }}" = "true" ]; then
            kustomize edit set image dazakharova/todo-broadcaster=dazakharova/todo-broadcaster:${{ github.sha }}
          fi

      - name: Commit kustomization update
        if: |
          steps.changes.outputs.todo_app == 'true' ||
          steps.changes.outputs.todo_backend == 'true' ||
          steps.changes.outputs.broadcaster == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          add: "the_project/kustomization.yaml"
          message: "Release the project ${{ github.sha }}"
